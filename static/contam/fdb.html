<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>CONTAM FDB Fan Motor Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; }
  .container { max-width:1850px; margin:0 auto; padding:1rem; display:flex; flex-direction:column; gap:1rem; }
  .chart-row { display:flex; gap:1rem; overflow-x:auto; padding-bottom:1rem; }
  .chart-side { flex:0 0 700px; display:flex; flex-direction:column; gap:0.5rem; background:#fff; border-radius:8px; padding:0.5rem; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .section-header { background:#007bff; color:#fff; font-weight:700; padding:6px 8px; border-radius:6px; font-size:1rem; }
  .table-wrapper { background:#fff; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); padding:4px; overflow-x:auto; }
  table { border-collapse:collapse; width:100%; font-size:0.9rem; }
  th, td { border:1px solid #d0d6de; padding:6px 8px; text-align:center; white-space:nowrap; }
  tr:nth-child(even){background:#fbfdff;}
  td:first-child, th:first-child{background:#007bff; color:#fff; position:sticky; left:0; z-index:1; font-weight:700;}
  canvas { width:100% !important; max-height:500px; background:#fff; border-radius:8px; padding:4px; }
</style>
</head>
<body>
<div class="container" id="chartsContainer"></div>

<script>
Chart.register(ChartDataLabels);

function formatNumber(val, decimals=2){
  if(val==="" || val==null || isNaN(val)) return "";
  return Number(val).toLocaleString("en-US",{minimumFractionDigits:decimals,maximumFractionDigits:decimals});
}

function parseExcelDate(val){
  if(typeof val==="number"){
    const d = XLSX.SSF.parse_date_code(val);
    if(d) return new Date(d.y,d.m-1,d.d);
  }
  if(typeof val==="string"){
    let d = new Date(val);
    if(!isNaN(d)) return d;
  }
  return null;
}

function formatDateForTable(val,type="day"){
  if(type==="month") return val;
  const d = parseExcelDate(val);
  if(!d) return val;
  return String(d.getDate()).padStart(2,"0");
}

// สร้างตาราง
function renderTableVertical(tableId,data,type="day"){
  const table = document.getElementById(tableId);
  table.innerHTML="";
  if(!data.length) return;
  const headersOrder=["Date","Input Qty.","Output Qty.","Reject Qty.","% YIELD NG","Reject Content",
                      "ALL SURFACE  WHITE CONTAM",
                      "ALL SURFACE  YELLOW CONTAM",
                      "ALL SURFACE  OIL CONTAM",
                      "ALL SURFACE  STICKY CONTAM",
                      "Target"];
  const rows = headersOrder.map(h=>{
    const cells = data.map(r=>{
      let val = r[h]!==undefined?r[h]:"";
      if(h==="Date") val=formatDateForTable(val,type);
      else if(h==="Input Qty."||h==="Output Qty."||h==="Reject Qty."||h.includes("CONTAM")) val=(val==="")?"":formatNumber(val,0);
      else if(h==="% YIELD NG"||h==="Target") val=(val==="")?"":formatNumber(val,2)+"%";
      return `<td>${val}</td>`;
    }).join("");
    return `<tr><td>${h}</td>${cells}</tr>`;
  }).join("");
  table.innerHTML=`<tbody>${rows}</tbody>`;
}

// สร้างกราฟ
function createChartContam(ctx, data, maxY1){
  return new Chart(ctx,{
    type:"bar",
    data:{
      labels:data.map(r=>r["Date"]),
      datasets:[
        { label:"WHITE CONTAM", type:"bar", data:data.map(r=>r["ALL SURFACE  WHITE CONTAM"]),
          backgroundColor:"#FFFACD", stack:"Contam", order:2, datalabels:{display:false} },
        { label:"YELLOW CONTAM", type:"bar", data:data.map(r=>r["ALL SURFACE  YELLOW CONTAM"]),
          backgroundColor:"#FFDAB9", stack:"Contam", order:2, datalabels:{display:false} },
        { label:"OIL CONTAM", type:"bar", data:data.map(r=>r["ALL SURFACE  OIL CONTAM"]),
          backgroundColor:"#00FFFF", stack:"Contam", order:2, datalabels:{display:false} },
        { label:"STICKY CONTAM", type:"bar", data:data.map(r=>r["ALL SURFACE  STICKY CONTAM"]),
          backgroundColor:"#E6E6FA", stack:"Contam", order:2, datalabels:{display:false} },
        { label:"% YIELD NG", type:"line", data:data.map(r=>r["% YIELD NG"]),
          borderColor:"Magenta", backgroundColor:"rgba(255,0,255,0.2)", borderWidth:3, tension:0.2, yAxisID:"y1", order:1,
          datalabels:{display:true,align:'top',anchor:'end',offset:10,rotation:-90,color:"Magenta",formatter:v=>formatNumber(v,2)+"%"} },
        { label:"Target", type:"line", data:data.map(r=>r["Target"]),
          borderColor:"#00FA9A", backgroundColor:"rgba(0,250,154,0.2)", borderDash:[5,5], borderWidth:3, tension:0.3, yAxisID:"y1", order:1,
          datalabels:{display:false} }
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{
          display:true,
          position:"top",
          align:"center",
          labels:{
            usePointStyle:true,
            pointStyle:(ctx)=> ctx.dataset.type==="bar"?"rect":"line",
            padding:20,
            font:{size:12},
            generateLabels:(chart)=>{
              return chart.data.datasets.map((ds,i)=>{
                let pointStyle = ds.type==="bar"?"rect":"line";
                return {
                  text:ds.label,
                  fillStyle:ds.backgroundColor,
                  strokeStyle:ds.borderColor,
                  lineWidth: ds.type==="line"?3:1,
                  pointStyle:pointStyle,
                  lineDash: ds.borderDash || [],
                  datasetIndex:i
                }
              });
            }
          }
        }
      },
      scales:{
        x:{ stacked:true, ticks:{maxRotation:90,minRotation:0} },
        y:{ stacked:true, beginAtZero:true, position:"left", title:{display:true,text:"Qty"} },
        y1:{ beginAtZero:false, min:0, max:maxY1, position:"right", grid:{drawOnChartArea:false},
             title:{display:true,text:"%"}, ticks:{callback:v=>formatNumber(v,2)+"%"} }
      }
    }
  });
}

// Config
const chartConfigs = [
  { name: "X1780", startRow: 46, endRow: 56, maxY1Month: 1, maxY1Day: 0.1},
  { name: "X1844", startRow: 74, endRow: 84, maxY1Month: 1.2, maxY1Day: 0.1 },
  { name: "X1930", startRow: 102, endRow: 112, maxY1Month: 0.5, maxY1Day: 0.1 },
  { name: "X2676", startRow: 130, endRow: 140, maxY1Month: 2, maxY1Day: 0.1 },
  { name: "X2977", startRow: 159, endRow: 169, maxY1Month: 0.5, maxY1Day: 0.8 },
  { name: "X3092", startRow: 188, endRow: 198, maxY1Month: 0.5, maxY1Day: 1 },
  { name: "X2674", startRow: 217, endRow: 227, maxY1Month: 0.1, maxY1Day: 0.5 },
  { name: "ALL FDB Fan Motor", startRow: 246, endRow: 255, maxY1Month: 0.4, maxY1Day: 0.25 }
];

function getMetrics(sheetData,startRow,endRow){
  const metrics=[];
  for(let r=startRow;r<=endRow;r++){
    const val=sheetData[r][0]||"";
    if(val) metrics.push(val);
  }
  return metrics;
}

function extractData(sheetData, cfg, startCol, endCol, metrics){
  const dateRow = sheetData[45];
  const dates=[];
  for(let c=startCol;c<=endCol;c++) dates.push(dateRow[c]);

  return dates.map((d,colIdx)=>{
    const obj={Date:d};
    metrics.forEach((m,rowIdx)=>{
      let val = sheetData[cfg.startRow+rowIdx][startCol+colIdx] || 0;
      if(m==="Target") val=Number(val)*100;
      else if(m!=="% YIELD NG" && m!=="Reject Content") val=Number(val);
      obj[m]=val;
    });
    const input=Number(obj["Input Qty."])||0;
    const scrap=Number(obj["Reject Qty."])||0;
    obj["% YIELD NG"]= input>0 ? parseFloat(((scrap/input)*100).toFixed(2)) : 0;
    if(obj["Target"]!==undefined) obj["Target"]=parseFloat(obj["Target"].toFixed(2));
    return obj;
  });
}

document.addEventListener("DOMContentLoaded",()=>{
  fetch("/static/1st'Yield Trend of Contam on Aug'25  (Update 24-Aug-25).xlsx")
    .then(res=>res.arrayBuffer())
    .then(data=>{
      const wb=XLSX.read(data,{type:"array"});
      const sheet=wb.Sheets[wb.SheetNames[8]];
      const sheetData=XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});
      const container=document.getElementById("chartsContainer");

      chartConfigs.forEach((cfg,index)=>{
        const metrics=getMetrics(sheetData,cfg.startRow,cfg.endRow);

        const startColDay=XLSX.utils.decode_col("DB");
        const endColDay=XLSX.utils.decode_col("EF");
        const startColMonth=XLSX.utils.decode_col("CH");
        const endColMonth=XLSX.utils.decode_col("DA");

        const dailyData=extractData(sheetData,cfg,startColDay,endColDay,metrics);
        const monthlyData=extractData(sheetData,cfg,startColMonth,endColMonth,metrics);

        const chartRow=document.createElement("div");
        chartRow.className="chart-row";
        chartRow.innerHTML=`
          <div class="chart-side">
            <div class="section-header">${cfg.name} : Monthly Trend</div>
            <canvas id="barChartMonth${index}"></canvas>
            <div class="table-wrapper"><table id="tableMonth${index}"></table></div>
          </div>
          <div class="chart-side">
            <div class="section-header">${cfg.name} : Daily Trend</div>
            <canvas id="barChartDay${index}"></canvas>
            <div class="table-wrapper"><table id="tableDay${index}"></table></div>
          </div>
        `;
        container.appendChild(chartRow);

        renderTableVertical(`tableDay${index}`,dailyData,"day");
        createChartContam(document.getElementById(`barChartDay${index}`),dailyData,cfg.maxY1Day);
        renderTableVertical(`tableMonth${index}`,monthlyData,"month");
        createChartContam(document.getElementById(`barChartMonth${index}`),monthlyData,cfg.maxY1Month);
      });
    });
});
</script>
</body>
</html>
