<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Dent & Scartch Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; }

  .container { max-width: 1850px; margin: 0 auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }

  .chart-row { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }

  .chart-side { flex: 0 0 700px; display: flex; flex-direction: column; gap: 0.5rem; background: #fff;
    border-radius: 8px; padding: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

  .section-header { background: #007bff; color: #fff; font-weight: 700; padding: 6px 8px; border-radius: 6px; font-size: 1rem; }

  .table-wrapper { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); padding: 4px; overflow-x: auto; }

  table { border-collapse: collapse; width: 100%; font-size: 0.9rem; }
  th, td { border: 1px solid #d0d6de; padding: 6px 8px; text-align: center; white-space: nowrap; }
  tr:nth-child(even) { background: #fbfdff; }
  td:first-child, th:first-child { background: #007bff; color: #fff; position: sticky; left: 0; z-index: 1; font-weight: 700; }
  canvas { width: 100% !important; max-height: 500px; background: #fff; border-radius: 8px; padding: 4px; }
</style>
</head>
<body>
<div class="container">
  <div class="chart-row">
    <div class="chart-side">
      <div class="section-header">Dent & Scartch : Monthly Trend (2024-Now)</div>
      <canvas id="barChartMonth"></canvas>
      <div class="table-wrapper"><table id="tableMonth"></table></div>
    </div>
    <div class="chart-side">
      <div class="section-header">Dent & Scartch : Daily Trend (LastMonth)</div>
      <canvas id="barChartDay"></canvas>
      <div class="table-wrapper"><table id="tableDay"></table></div>
    </div>
  </div>
</div>

<script>
Chart.register(ChartDataLabels);

function formatNumber(val, decimals=2){
  if(val==="" || val==null || isNaN(val)) return "";
  return Number(val).toLocaleString("en-US",{minimumFractionDigits:decimals,maximumFractionDigits:decimals});
}

function parseExcelDate(val){
  if(typeof val==="number"){ const d=XLSX.SSF.parse_date_code(val); if(d) return new Date(d.y,d.m-1,d.d); }
  if(typeof val==="string"){ let d=new Date(val); if(!isNaN(d)) return d; }
  return null;
}

function parseMonthText(val){
  const match=/([a-zA-Z]+)'(\d{2})/.exec(val);
  if(match){ const monthStr=match[1]; const year=2000+parseInt(match[2]); const month=new Date(Date.parse(monthStr+" 1,2000")).getMonth(); return new Date(year,month,1);}
  return null;
}

function formatDateForTable(val,type="day"){
  if(type==="month") return val;
  const d=parseExcelDate(val); if(!d) return val;
  if(type==="day") return String(d.getDate()).padStart(2,"0");
  return val;
}

// โหลด Excel
async function loadExcel(filePath){
  const response=await fetch(filePath);
  const arrayBuffer=await response.arrayBuffer();
  const wb=XLSX.read(arrayBuffer,{type:"array"});
  const sheet=wb.Sheets[wb.SheetNames[1]];
  const sheetData=XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});
  const headerRow=sheetData[30];
  const metrics=["Input Qty.","Scrap. Qty.","% NG.","Reject Content","Dent","% NG. Dent","Scratch","% NG. Scratch","Target"];
  return {sheetData,headerRow,metrics};
}

function extractData(sheetData, headerRow, metrics, startCol, endCol, type="month"){
  const dates=[];
  for(let c=startCol;c<=endCol;c++){
    const colVal=headerRow[c];
    let dateObj=(type==="month")?parseMonthText(colVal):parseExcelDate(colVal);
    if(dateObj){ 
      if(type==="month"){ if(dateObj.getFullYear()>=2024 && dateObj<=new Date()) dates.push({label:colVal,idx:c}); }
      else dates.push({label:colVal,idx:c,dateObj});
    }
  }
  let useDates=dates;
  if(type==="day" && dates.length){
    const lastDate=[...dates].sort((a,b)=>b.dateObj-a.dateObj)[0].dateObj;
    useDates=dates.filter(d=>d.dateObj.getMonth()===lastDate.getMonth() && d.dateObj.getFullYear()===lastDate.getFullYear());
  }
  const result=useDates.map(d=>{
    const obj={Date:d.label};
    metrics.forEach((m,idx)=>{
      const row=sheetData[31+idx];
      let val=row[d.idx]||0;
      if(val===""||val==null) val=0;
      else if(m==="Target") val=Number(val)*100;
      else if(m!=="% NG." && m!=="% NG. Dent" && m!=="% NG. Scratch") val=Number(val);
      obj[m]=val;
    });
    const input=Number(obj["Input Qty."])||0;
    const scrap=Number(obj["Scrap. Qty."])||0;
    const dent=Number(obj["Dent"])||0;
    const scratch=Number(obj["Scratch"])||0;
    obj["% NG."]=input>0?parseFloat(((scrap/input)*100).toFixed(2)):0;
    obj["% NG. Dent"]=input>0?parseFloat(((dent/input)*100).toFixed(2)):0;
    obj["% NG. Scratch"]=input>0?parseFloat(((scratch/input)*100).toFixed(2)):0;
    obj["Target"]=parseFloat((obj["Target"]||0).toFixed(2));
    return obj;
  });
  return result;
}

function renderTableVertical(tableId,data,type="day"){
  const table=document.getElementById(tableId);
  table.innerHTML="";
  if(!data.length) return;
  const headersOrder=["Date","Input Qty.","Scrap. Qty.","% NG.","Reject Content","Dent","% NG. Dent","Scratch","% NG. Scratch","Target"];
  const rows=headersOrder.map(h=>{
    const cells=data.map(r=>{
      let val=r[h]!==undefined?r[h]:"";
      if(h==="Date") val=formatDateForTable(val,type);
      else if(h==="Input Qty."||h==="Scrap. Qty."||h==="Dent"||h==="Scratch") val=(val==="")?"":formatNumber(val,0);
      else if(h==="% NG."||h==="Target"||h==="% NG. Dent"||h==="% NG. Scratch") val=(val==="")?"":formatNumber(val,2)+"%";
      return `<td>${val}</td>`;
    }).join("");
    return `<tr><td>${h}</td>${cells}</tr>`;
  }).join("");
  table.innerHTML=`<tbody>${rows}</tbody>`;
}

function createChart(ctx,data,labelKey,isMonth=true,y1Min=null,y1Max=null){
  if(y1Min===null) y1Min=0;
  if(y1Max===null) y1Max=isMonth?0.3:0.3;
  return new Chart(ctx,{
    type:"bar",
    data:{ labels:data.map(r=>formatDateForTable(r[labelKey],isMonth?"month":"day")),
      datasets:[
        {label:"Dent",type:"bar",data:data.map(r=>r["Dent"]),backgroundColor:"#FFFACD",yAxisID:"y",stack:"Contam",order:2,datalabels:{display:false}},
        {label:"Scratch",type:"bar",data:data.map(r=>r["Scratch"]),backgroundColor:"#E6E6FA",yAxisID:"y",stack:"Contam",order:2,datalabels:{display:false}},
        {label:"% NG.",type:"line",data:data.map(r=>r["% NG."]),borderColor:"Magenta",backgroundColor:"rgba(255,0,255,0.2)",borderWidth:3,tension:0.3,yAxisID:"y1",order:1,
          datalabels:{display:true,align:'top',anchor:'end',offset:10,rotation:-90,color:"Magenta",formatter:v=>formatNumber(v,2)+"%"}},
        {label:"Target",type:"line",data:data.map(r=>r["Target"]),borderColor:"#00FA9A",backgroundColor:"rgba(0,250,154,0.2)",borderDash:[5,5],borderWidth:3,tension:0.3,yAxisID:"y1",order:1,datalabels:{display:false}}
      ]},
    options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
            position: "top",
            align: "center",
            labels: {
              usePointStyle: true,
              pointStyle: function(context) {
                if (context.datasetIndex === 0) return 'rect';
                return 'line';
              },
              padding: 20,
              font: {
                size: 12
              },
              generateLabels: function(chart) {
                const datasets = chart.data.datasets;
                return datasets.map((dataset, index) => {
                  let pointStyle = 'line';
                  let borderDash = [];
                  
                  if (dataset.type === 'bar') {
                    pointStyle = 'rect';
                  } else if (dataset.borderDash) {
                    borderDash = dataset.borderDash;
                  }

                  return {
                    text: dataset.label,
                    fillStyle: dataset.backgroundColor,
                    strokeStyle: dataset.borderColor,
                    lineWidth: dataset.type === 'line' ? 3 : 1,
                    pointStyle: pointStyle,
                    lineDash: borderDash,
                    datasetIndex: index
                  };
                });
              }
            }
          },
          datalabels: {}
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 90,
              minRotation: 90
            }
          },
          y: {
            beginAtZero: true,
            position: "left",
            title: {
              display: true,
              text: "Qty"
            }
          },
          y1: {
            beginAtZero: false,
            min: y1Min,
            max: y1Max,
            position: "right",
            grid: {
              drawOnChartArea: false
            },
            title: {
              display: true,
              text: "%"
            },
            ticks: {
              callback: v => formatNumber(v, 2) + "%"
            }
          }
        }
      }
    });
  }


document.addEventListener("DOMContentLoaded",async ()=>{
  try{
    const {sheetData,headerRow,metrics}=await loadExcel("1st'Yield Trend of Dent & Scratch Hub (Prime) on Aug'25 (Update 24-Aug-25).xlsx");
    const monthlyData=extractData(sheetData,headerRow,metrics,XLSX.utils.decode_col("EE"),XLSX.utils.decode_col("EX"),"month");
    const dailyData=extractData(sheetData,headerRow,metrics,XLSX.utils.decode_col("EY"),XLSX.utils.decode_col("GC"),"day");
    renderTableVertical("tableMonth",monthlyData,"month");
    createChart(document.getElementById("barChartMonth"),monthlyData,"Date",true);
    renderTableVertical("tableDay",dailyData,"day");
    createChart(document.getElementById("barChartDay"),dailyData,"Date",false);
  }catch(err){ console.error(err); alert("โหลดไฟล์ล้มเหลว"); }
});
</script>
</body>
</html>
