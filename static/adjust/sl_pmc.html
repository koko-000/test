<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ADJUST MACHINE SLEEVE PMC Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<style>
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; color: #222; }

  /* container หลัก */
  .container { 
    max-width: 1850px; 
    margin: 0 auto; 
    padding: 1rem; 
    display: flex; 
    flex-direction: column; 
    gap: 1rem; 
  }

  /* chart-row สำหรับแต่ละเครื่อง ให้ scroll แนวนอน */
  .chart-row {
    display: flex; 
    gap: 1rem; 
    overflow-x: auto; 
    padding-bottom: 1rem;
  }

  /* chart-side สำหรับ Monthly / Daily */
  .chart-side {
    flex: 0 0 550px; /* กำหนดความกว้างคงที่เพื่อ scroll */
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background: #fff;
    border-radius: 8px;
    padding: 0.5rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .section-header { 
    background: #007bff; 
    color: #fff; 
    font-weight: 700; 
    padding: 6px 8px; 
    border-radius: 6px; 
    font-size: 1rem; 
  }

  .table-wrapper { 
    background: #fff; 
    border-radius: 8px; 
    box-shadow: 0 1px 4px rgba(0,0,0,0.08); 
    padding: 4px; 
    overflow-x: auto; 
  }

  table { 
    border-collapse: collapse; 
    width: 100%; 
    font-size: 0.9rem; 
  }
  th, td { 
    border: 1px solid #d0d6de; 
    padding: 6px 8px; 
    text-align: center; 
    white-space: nowrap; 
  }
  tr:nth-child(even) { background: #fbfdff; }
  td:first-child, th:first-child { 
    background: #007bff; 
    color: #fff; 
    position: sticky; 
    left: 0; 
    z-index: 1; 
    font-weight: 700; 
  }
  canvas { 
    width: 100% !important; 
    max-height: 300px; 
    background: #fff; 
    border-radius: 8px; 
    padding: 4px; 
  }
</style>
</head>
<body>
<div class="container" id="chartsContainer"></div>

<script>
Chart.register(ChartDataLabels);

function formatNumber(val, decimals=2){
  if(val==="" || val==null || isNaN(val)) return "";
  return Number(val).toLocaleString("en-US", {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
}

function parseExcelDate(val){
  if(typeof val==="number"){
    const d = XLSX.SSF.parse_date_code(val);
    if(d) return new Date(d.y,d.m-1,d.d);
  }
  if(typeof val==="string"){
    let d = new Date(val);
    if(!isNaN(d)) return d;
  }
  return null;
}

function formatDateForTable(val,type="day"){
  if(type==="month") return val;
  const d = parseExcelDate(val);
  if(!d) return val;
  if(type==="day") return String(d.getDate()).padStart(2,"0");
  return val;
}

// render table vertical
function renderTableVertical(tableId,data,type="day"){
  const table = document.getElementById(tableId);
  table.innerHTML="";
  if(!data.length) return;
  const headersOrder = ["Date","Input Qty.","Scrap. Qty.","% NG.","Reject Content","Adjust M/C","Target"];
  const rows = headersOrder.map(h=>{
    const cells = data.map(r=>{
      let val = r[h]!==undefined?r[h]:"";
      if(h==="Date") val = formatDateForTable(val,type);
      else if(h==="Input Qty." || h==="Scrap. Qty." || h==="Adjust M/C") val = (val==="") ? "" : formatNumber(val,0);
      else if(h==="% NG." || h==="Target") val = (val==="") ? "" : formatNumber(val,2)+"%";
      return `<td>${val}</td>`;
    }).join("");
    return `<tr><td>${h}</td>${cells}</tr>`;
  }).join("");
  table.innerHTML=`<tbody>${rows}</tbody>`;
}

// create charts
function createChart(ctx, data, maxY1){
  return new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.map(r => r["Date"]),
      datasets: [
        { 
          label: "Scrap Qty.", 
          type: "bar", 
          data: data.map(r => Number(r["Scrap. Qty."])), 
          backgroundColor: "#FFFACD", 
          barPercentage: 0.7, 
          categoryPercentage: 0.6, 
          yAxisID: "y", 
          order: 2, 
          datalabels: { display: false }
        },
        { 
          label: "% NG.", 
          type: "line", 
          data: data.map(r => r["% NG."]), 
          borderColor: "Magenta", 
          backgroundColor: "rgba(255,0,255,0.2)", 
          borderWidth: 3, 
          tension: 0.3, 
          yAxisID: "y1", 
          order: 1, 
          datalabels: { display: true, align:'top', anchor:'end', offset:10, rotation:-90, color:"Magenta", formatter:v => formatNumber(v,2) + "%" }
        },
        { 
          label: "Target", 
          type: "line", 
          data: data.map(r => r["Target"]), 
          borderColor: "#00FA9A", 
          backgroundColor: "rgba(0,250,154,0.2)", 
          borderDash: [5,5], 
          borderWidth: 3, 
          tension: 0.3, 
          yAxisID: "y1", 
          order: 1, 
          datalabels: { display: false }
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: "top",
          align: "center",
          labels: {
            usePointStyle: true,
            pointStyle: ctx => ctx.dataset.type === "bar" ? "rect" : "line",
            padding: 20,
            font: { size: 12 },
            generateLabels: function(chart) {
              return chart.data.datasets.map((dataset, index) => {
                let pointStyle = dataset.type === 'bar' ? 'rect' : 'line';
                let lineDash = dataset.borderDash || [];
                return {
                  text: dataset.label,
                  fillStyle: dataset.backgroundColor,
                  strokeStyle: dataset.borderColor,
                  lineWidth: dataset.type === 'line' ? 3 : 1,
                  pointStyle,
                  lineDash,
                  datasetIndex: index
                };
              });
            }
          }
        },
        datalabels: {}
      },
      scales: {
        x: { ticks: { maxRotation: 90, minRotation: 0 } },
        y: { beginAtZero: true, position: "left", title: { display: true, text: "Qty" } },
        y1: { beginAtZero: false, min: 0, max: maxY1, position: "right", grid: { drawOnChartArea: false }, title: { display: true, text: "%" }, ticks: { callback: v => formatNumber(v,2) + "%" } }
      }
    }
  });
}

// --- run ---
document.addEventListener("DOMContentLoaded", () => {
  fetch("/static/1st'Yield Trend of Adjust machine on Aug'25 (Update 24-Aug-25).xlsx")
    .then(res => res.arrayBuffer())
    .then(data => {
      const wb = XLSX.read(data, { type: "array" });
      const sheet = wb.Sheets[wb.SheetNames[8]];
      const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

      const chartConfigs = [
        { name: "SKB1", startRow:26, endRow:32, maxY1Month:70, maxY1Day:0.2 },
        { name: "SKB2", startRow:57, endRow:63, maxY1Month:20, maxY1Day:120 },
        { name: "ALL STT", startRow:88, endRow:94, maxY1Month:14, maxY1Day:120 }
      ];

      const container = document.getElementById("chartsContainer");

      chartConfigs.forEach((cfg, index) => {
        const metrics = sheetData.slice(cfg.startRow, cfg.endRow + 1).map(r => r[0] || "");

        // กำหนด column สำหรับ daily/monthly
        const startColDay = XLSX.utils.decode_col("ED");
        const endColDay = XLSX.utils.decode_col("FH");
        const startColMonth = XLSX.utils.decode_col("DJ");
        const endColMonth = XLSX.utils.decode_col("EC");

        // ฟังก์ชันสร้าง data array
        function extractData(startCol, endCol, type) {
          const dateRow = sheetData[25];
          const dates = [];
          for (let c = startCol; c <= endCol; c++) dates.push(dateRow[c]);
          return dates.map((d, colIdx) => {
            const obj = { Date: d };
            metrics.forEach((m, rowIdx) => {
              let val = sheetData[cfg.startRow + rowIdx][startCol + colIdx] || 0;
              if (m === "Target") val = Number(val) * 100;
              else if (m !== "% NG." && m !== "Reject Content") val = Number(val);
              obj[m] = val;
            });
            const input = Number(obj["Input Qty."]) || 0;
            const scrap = Number(obj["Scrap. Qty."]) || 0;
            obj["% NG."] = input > 0 ? parseFloat(((scrap / input) * 100).toFixed(2)) : 0;
            if (obj["Target"] !== undefined) obj["Target"] = parseFloat(obj["Target"].toFixed(2));
            return obj;
          });
        }

        const dailyData = extractData(startColDay, endColDay, "day");
        const monthlyData = extractData(startColMonth, endColMonth, "month");

        // create chart-row
        const chartRow = document.createElement("div");
        chartRow.className = "chart-row";
        chartRow.innerHTML = `
          <div class="chart-side">
            <div class="section-header">${cfg.name} : Monthly Trend</div>
            <canvas id="barChartMonth${index}"></canvas>
            <div class="table-wrapper"><table id="tableMonth${index}"></table></div>
          </div>
          <div class="chart-side">
            <div class="section-header">${cfg.name} : Daily Trend</div>
            <canvas id="barChartDay${index}"></canvas>
            <div class="table-wrapper"><table id="tableDay${index}"></table></div>
          </div>
        `;
        container.appendChild(chartRow);

        renderTableVertical(`tableDay${index}`, dailyData, "day");
        createChart(document.getElementById(`barChartDay${index}`), dailyData, cfg.maxY1Day);
        renderTableVertical(`tableMonth${index}`, monthlyData, "month");
        createChart(document.getElementById(`barChartMonth${index}`), monthlyData, cfg.maxY1Month);
      });
    });
});

</script>
</body>
</html>
